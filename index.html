<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>New Transaction</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --fs-body: clamp(14px, 1.9vw, 16px);
            --fs-title: clamp(18px, 2.8vw, 22px);
            --fs-label: clamp(13px, 2.3vw, 14px);
            --space-1: clamp(6px, 1.2vw, 10px);
            --space-2: clamp(10px, 2vw, 16px);
            --space-3: clamp(14px, 3vw, 24px);
            --space-4: clamp(16px, 4vw, 32px);
            --space-6: clamp(20px, 5vw, 40px);
            --space-8: clamp(24px, 6vw, 48px);
        }
        
        body {
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            background: #f7f7fb;
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: var(--space-3);
            font-size: var(--fs-body);
            line-height: 1.5;
            /* Ensure body can scroll on all devices */
            overflow-x: hidden;
        }
        
        .form-container {
            width: 100%;
            max-width: clamp(340px, 92vw, 920px);
            border: 1px solid #e6e6ef;
            border-radius: clamp(12px, 3vw, 16px);
            background: #fff;
            box-shadow: 0 8px 24px rgba(16, 24, 40, 0.06);
        }
        
        .header-bg {
            background: linear-gradient(180deg, #4285F4 0%, #3b78e7 100%);
            color: #fff;
            border-radius: clamp(12px, 3vw, 16px) clamp(12px, 3vw, 16px) 0 0;
            padding-left: max(16px, env(safe-area-inset-left));
            padding-right: max(16px, env(safe-area-inset-right));
        }
        
        /* Fields */
        .field-label {
            display: block;
            color: #111827;
            font-weight: 700;
            font-size: var(--fs-label);
            margin-bottom: var(--space-1);
        }
        
        .required-label::after {
            content: '*';
            color: #ea4335;
            margin-left: 4px;
        }
        
        input[type="text"],
        input[type="date"],
        select {
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: clamp(10px, 2.2vw, 12px) clamp(12px, 3vw, 14px);
            transition: box-shadow .2s, border-color .2s, background-color .2s;
            background: #fff;
            font-size: 1rem;
            line-height: 1.4;
            min-height: 44px;
        }
        
        input[type="text"]:focus,
        input[type="date"]:focus,
        select:focus {
            outline: none;
            border-color: #4285F4;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.18);
        }
        
        /* Toggle pills for Type */
        .type-toggle {
            display: inline-flex;
            gap: clamp(6px, 1.5vw, 8px);
            background: #f3f4f6;
            border-radius: 999px;
            padding: clamp(4px, 1.5vw, 6px);
            border: 1px solid #e5e7eb;
        }
        
        .pill {
            display: inline-flex;
            align-items: center;
            gap: clamp(6px, 1.5vw, 8px);
            padding: clamp(8px, 2.2vw, 12px) clamp(12px, 3vw, 16px);
            border-radius: 999px;
            font-weight: 600;
            color: #374151;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all .2s ease;
            user-select: none;
            position: relative;
            min-height: 44px;
        }
        
        .pill:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        
        .pill.active {
            background: #e8f1ff !important;
            color: #0b57d0 !important;
            border-color: #93c5fd !important;
            box-shadow: 0 0 0 3px rgba(66,133,244,0.18);
        }
        
        .pill input {
            display: none;
        }
        
        /* Input groups (prefix) */
        .input-group {
            display: flex;
            align-items: center;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            background: #fff;
            min-height: 44px;
        }
        
        .input-prefix {
            background: #f9fafb;
            color: #6b7280;
            font-weight: 600;
            padding: clamp(8px, 2.2vw, 10px) clamp(10px, 2.5vw, 12px);
            border-right: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        
        .input-group input {
            border: none;
            outline: none;
            padding: clamp(10px, 2.2vw, 12px) clamp(12px, 3vw, 14px);
            width: 100%;
        }
        
        .input-group:focus-within {
            border-color: #4285F4;
            box-shadow: 0 0 0 3px rgba(66,133,244,0.18);
        }
        
        /* Section spacing */
        .section {
            padding: 0 var(--space-3) var(--space-3);
        }
        
        .section + .section {
            border-top: 1px dashed #e5e7eb;
            padding-top: var(--space-3);
        }
        
        /* Buttons */
        .btn {
            padding: clamp(10px, 2.2vw, 12px) clamp(14px, 3vw, 18px);
            border-radius: 999px;
            font-weight: 600;
            transition: transform .15s ease, box-shadow .15s ease, background .2s, color .2s;
            box-shadow: 0 2px 3px rgba(0,0,0,0.08);
            min-height: 44px;
            min-width: clamp(120px, 30vw, 180px);
        }
        
        .btn:disabled {
            opacity: .7;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        
        .btn-clear {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #e5e7eb;
        }
        
        .btn-clear:hover {
            background: #e5e7eb;
        }
        
        .btn-save {
            background: #4285F4;
            color: #fff;
        }
        
        .btn-save:hover {
            background: #3b78e7;
        }
        
        /* Message box */
        #messageBox {
            margin: var(--space-2) var(--space-3) var(--space-3);
            padding: clamp(10px, 2.2vw, 12px) clamp(12px, 3vw, 14px);
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            font-size: clamp(0.9rem, 2.3vw, 0.95rem);
        }
        
        #messageBox.bg-green-100 {
            border: 1px solid #86efac;
        }
        
        #messageBox.bg-red-100 {
            border: 1px solid #fca5a5;
        }
        
        /* Helper text for errors */
        .helper {
            margin-top: var(--space-1);
            font-size: clamp(0.75rem, 2vw, 0.82rem);
            color: #dc2626;
            display: none;
        }
        
        .has-error input,
        .has-error select,
        .has-error .input-group {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.12) !important;
        }
        
        .has-error .helper {
            display: block;
        }
        
        /* Inline select styling when multiple matches are found */
        .inline-select {
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: clamp(8px, 2.2vw, 10px) clamp(10px, 2.5vw, 12px);
            background: #fff;
            min-height: 44px;
        }
        
        .inline-select:focus {
            outline: none;
            border-color: #4285F4;
            box-shadow: 0 0 0 3px rgba(66,133,244,0.18);
        }

        .fee-summary {
            margin: 0 var(--space-3) var(--space-1);
            border: 1px solid #e6e6ef;
            border-radius: 12px;
            background: #fff;
            overflow: hidden;
        }
        
        .fee-summary-header {
            background: #f9fafb;
            padding: clamp(8px, 2.2vw, 10px) clamp(10px, 2.5vw, 12px);
            font-weight: 700;
            color: #111827;
            border-bottom: 1px solid #e6e6ef;
        }
        
        .fee-summary-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        .fee-summary-table th,
        .fee-summary-table td {
            padding: clamp(8px, 2.2vw, 10px) clamp(10px, 2.5vw, 12px);
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
            word-break: break-word;
            overflow-wrap: break-word;
            min-width: 0;
        }
        
        .fee-summary-table th {
            font-size: clamp(0.8rem, 2.2vw, 0.88rem);
            color: #6b7280;
            font-weight: 700;
            white-space: nowrap;
        }
        
        .fee-summary-table td {
            font-size: clamp(0.85rem, 2.5vw, 0.95rem);
            color: #111827;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Ensure amounts are fully visible on mobile */
        .fee-summary-table td:last-child {
            text-align: right;
            white-space: nowrap;
            overflow: visible;
            text-overflow: clip;
        }
        
        .fee-summary-table td:nth-child(2) {
            text-align: right;
            white-space: nowrap;
            overflow: visible;
            text-overflow: clip;
        }
        
        .fee-muted {
            color: #6b7280;
            font-weight: 600;
        }
        
        .fee-due {
            color: #b45309;
            font-weight: 800;
        }

        /* Success popup */
        .modal-overlay {
            position: fixed; 
            inset: 0;
            background: rgba(17, 24, 39, 0.55);
            display: none; 
            align-items: center; 
            justify-content: center;
            z-index: 30000;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .modal-overlay.show { display: flex; }

        .modal-card {
            width: min(92vw, 520px);
            background: #fff;
            border-radius: clamp(12px, 3vw, 16px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.25);
            overflow: hidden;
        }

        .modal-head {
            padding: clamp(12px, 2.5vw, 14px) clamp(16px, 3vw, 18px);
            background: #e8f1ff;
            border-bottom: 1px solid #dbeafe;
            display: flex; 
            align-items: center; 
            gap: 10px;
            color: #0b57d0; 
            font-weight: 800;
        }
        
        .modal-body {
            padding: clamp(14px, 3vw, 16px) clamp(16px, 3vw, 18px) clamp(6px, 2vw, 8px);
        }
        
        .modal-row {
            margin-bottom: clamp(6px, 2vw, 8px);
            color: #374151;
            font-size: clamp(0.85rem, 2.5vw, 0.95rem);
        }
        
        .modal-row .label {
            color: #6b7280; 
            font-weight: 600; 
            margin-right: 8px;
        }
        
        .modal-success {
            margin-top: clamp(8px, 2.5vw, 10px);
            background: #ecfdf5;
            border: 1px solid #a7f3d0;
            color: #065f46;
            padding: clamp(8px, 2.2vw, 10px) clamp(10px, 2.5vw, 12px);
            border-radius: 10px;
            font-weight: 700;
        }
        
        .modal-actions {
            display: flex; 
            gap: clamp(8px, 2.5vw, 10px); 
            justify-content: flex-end;
            padding: clamp(12px, 2.5vw, 14px) clamp(16px, 3vw, 18px) clamp(16px, 3vw, 18px);
        }
        
        .btn-wa {
            background: #25D366; 
            color: white; 
            font-weight: 700;
            border-radius: 999px; 
            padding: clamp(8px, 2.2vw, 10px) clamp(12px, 3vw, 14px);
            min-height: 44px;
        }
        
        .btn-wa:hover { filter: brightness(0.95); }
        
        .btn-done {
            background: #111827; 
            color: white; 
            font-weight: 700;
            border-radius: 999px; 
            padding: clamp(8px, 2.2vw, 10px) clamp(14px, 3vw, 16px);
            min-height: 44px;
        }
        
        .btn-done:hover { filter: brightness(1.05); }
        
        /* Responsive breakpoints - mobile-first approach */
        @media (min-width: 480px) {
            .form-container { 
                border-radius: clamp(14px, 3.5vw, 18px); 
            }
        }
        
        @media (min-width: 640px) {
            .section { 
                padding: 0 clamp(16px, 3vw, 24px) clamp(16px, 3vw, 24px); 
            }
            #messageBox {
                margin: clamp(12px, 3vw, 16px) clamp(16px, 3vw, 24px) clamp(16px, 3vw, 24px);
            }
            .fee-summary {
                margin: 0 clamp(16px, 3vw, 24px) clamp(6px, 2vw, 8px);
            }
        }
        
        @media (min-width: 768px) {
            /* Switch to two columns comfortably */
            .section.grid { 
                grid-template-columns: repeat(2, minmax(0, 1fr)); 
            }
            .form-container { 
                max-width: 820px; 
            }
        }
        
        @media (min-width: 1024px) {
            .form-container { 
                max-width: 920px; 
            }
        }
        
        /* Mobile-specific adjustments */
        @media (max-width: 639px) {
            body {
                padding: var(--space-2);
            }
            
            .section {
                padding: 0 var(--space-2) var(--space-2);
            }
            
            .type-toggle {
                gap: clamp(4px, 1.2vw, 6px);
            }
            
            .pill {
                padding: clamp(6px, 2vw, 8px) clamp(10px, 2.5vw, 12px);
            }
            
            /* Ensure touch targets are properly sized on small screens */
            button, .pill, .inline-select, .input-group input {
                min-height: 44px;
            }
            
            /* Bottom-aligned primary actions for thumb reach */
            .section:last-child {
                padding-bottom: calc(var(--space-3) + env(safe-area-inset-bottom));
            }
            
            /* Mobile fee summary improvements */
            .fee-summary {
                margin: 0 var(--space-2) var(--space-1);
                border-radius: 8px;
            }
            
            .fee-summary-table th,
            .fee-summary-table td {
                padding: clamp(6px, 2vw, 8px) clamp(8px, 2.5vw, 10px);
                font-size: clamp(0.75rem, 2.8vw, 0.85rem);
            }
            
            .fee-summary-table th {
                font-size: clamp(0.7rem, 2.5vw, 0.8rem);
            }
            
            /* Ensure amounts are fully visible on very small screens */
            .fee-summary-table td {
                max-width: none;
                white-space: normal;
                word-break: break-all;
            }
            
            .fee-summary-table td:last-child,
            .fee-summary-table td:nth-child(2) {
                text-align: right;
                white-space: nowrap;
                word-break: keep-all;
            }
        }
        
        /* Extra small mobile devices */
        @media (max-width: 375px) {
            .fee-summary {
                margin: 0 8px 8px;
                border-radius: 6px;
            }
            
            .fee-summary-table th,
            .fee-summary-table td {
                padding: 6px 8px;
                font-size: 0.75rem;
            }
            
            .fee-summary-table th {
                font-size: 0.7rem;
            }
            
            /* Force single line for amounts on very small screens */
            .fee-summary-table td {
                white-space: nowrap;
                overflow: visible;
                text-overflow: clip;
            }
            
            /* Ensure proper column widths */
            .fee-summary-table th:nth-child(1),
            .fee-summary-table td:nth-child(1) {
                width: 33%;
            }
            
            .fee-summary-table th:nth-child(2),
            .fee-summary-table td:nth-child(2) {
                width: 33%;
            }
            
            .fee-summary-table th:nth-child(3),
            .fee-summary-table td:nth-child(3) {
                width: 34%;
            }
        }
        
        /* Input improvements for mobile */
        input::placeholder { 
            color: #9ca3af; 
        }
        
        /* Ensure proper input modes for mobile keyboards */
        #amount { 
            inputmode: decimal; 
        }
        
        #studentId { 
            inputmode: latin; 
        }
        
        #txId { 
            autocomplete: off; 
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-8 form-container">
        <!-- Header Section -->
        <div class="header-bg p-6 mb-10 text-center">
            <h1 class="font-bold tracking-normal" style="font-size: var(--fs-title);">New Transaction</h1>
        </div>

        <!-- Form Section -->
        <form id="transactionForm" class="grid grid-cols-1 gap-y-6">
            <!-- Section: Transaction Type -->
            <div class="section">
                <div class="mb-3">
                    <label class="field-label required-label">Type</label>
                </div>
                <div class="type-toggle" role="group" aria-label="Transaction type">
                    <label class="pill" id="pillPayments">
                        <input type="radio" id="payments" name="type" value="Payments" />
                        <span>PAYMENTS</span>
                    </label>
                    <label class="pill" id="pillRefunds">
                        <input type="radio" id="refunds" name="type" value="Refunds" />
                        <span>REFUNDS</span>
                    </label>
                </div>
                <p class="helper" id="typeHelper">Please select either PAYMENTS or REFUNDS.</p>
            </div>

            <!-- Section: Student & Course -->
            <div class="section grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6">
                <div id="field-studentId">
                    <label for="studentId" class="field-label required-label">Student ID</label>
                    <input type="text" id="studentId" name="studentId" required>
                    <p class="helper">Student ID is required</p>
                </div>

                <div id="field-studentName">
                    <label for="studentName" class="field-label required-label">Student Name</label>
                    <input type="text" id="studentName" name="studentName" required>
                    <p class="helper">Student name is required</p>
                </div>

                <div id="field-courseName">
                    <label for="courseName" class="field-label required-label">Course Name</label>
                    <input type="text" id="courseName" name="courseName" required>
                    <p class="helper">Course name is required</p>
            </div>

                <div id="field-batchNo">
                    <label for="batchNo" class="field-label required-label">Batch No.</label>
                    <input type="text" id="batchNo" name="batchNo" required>
                    <p class="helper">Batch number is required</p>
                </div>
            </div>

            <!-- Section: Payment Details -->
            <div class="section grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6">
                <!-- Fees/Paid/Due summary -->
                <div class="fee-summary" id="feeSummary" style="display:none;">
                    <div class="fee-summary-header">Payment Summary</div>
                    <table class="fee-summary-table">
                        <thead>
                            <tr>
                                <th>Fees</th>
                                <th>Paid</th>
                                <th>Due</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span id="feeTotal" class="fee-muted">—</span></td>
                                <td><span id="feePaid" class="fee-muted">—</span></td>
                                <td><span id="feeDue" class="fee-due">—</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="field-amount">
                    <label for="amount" class="field-label required-label">Amount</label>
                    <div class="input-group">
                        <span class="input-prefix">₹</span>
                        <input type="text" id="amount" name="amount" inputmode="decimal" placeholder="0.00" required>
                    </div>
                    <p class="helper">Enter a valid amount</p>
            </div>

                <div id="field-modeOfPayment">
                    <label for="modeOfPayment" class="field-label required-label">Mode Of Payment</label>
                    <select id="modeOfPayment" name="modeOfPayment" required>
                    <option value="">Select Mode</option>
                    <option value="Cash">Cash</option>
                    <option value="Online Transfer">Online Transfer</option>
                    <option value="Card">Card</option>
                    <option value="Cheque">Cheque</option>
                    <option value="UPI">UPI</option>
                </select>
                    <p class="helper">Please select a mode</p>
            </div>

                <div id="field-paymentType">
                    <label for="paymentType" class="field-label required-label">Payment Type</label>
                    <select id="paymentType" name="paymentType" required>
                    <option value="">Select Payment Type</option>
                    <option value="Token Amount">Token Amount</option>
                    <option value="First Instalment">First Instalment</option>
                    <option value="Part Instalment">Part Instalment</option>
                        <option value="Final Instalment">Final Instalment</option>
                    <option value="Full Payment">Full Payment</option>
                </select>
                    <p class="helper">Please select a payment type</p>
            </div>

                <div id="field-txId">
                    <label for="txId" class="field-label required-label">Tx ID</label>
                    <div class="input-group">
                        <span class="input-prefix">TX</span>
                        <input type="text" id="txId" name="txId" placeholder="Reference / UTR / Cheque No." required>
            </div>
                    <p class="helper">Transaction reference is required</p>
            </div>

                <div id="field-dateOfPayment">
                    <label for="dateOfPayment" class="field-label required-label">Date Of Payment</label>
                    <input type="date" id="dateOfPayment" name="dateOfPayment" required>
                    <p class="helper">Please select a date</p>
            </div>

                <div id="field-note">
                    <label for="note" class="field-label required-label">Note</label>
                    <input type="text" id="note" name="note" placeholder="Short note (e.g., Part payment via UPI)" required>
                    <p class="helper">Note is required</p>
            </div>
            </div>

            <!-- Actions -->
            <div class="section flex justify-end gap-3">
                <button type="button" id="clearButton" class="btn btn-clear">Clear</button>
                <button type="submit" id="saveButton" class="btn btn-save">Save</button>
            </div>
        </form>

        <!-- Message Box -->
        <div id="messageBox" class="hidden" role="alert"></div>

        <!-- Success Popup Modal -->
        <div class="modal-overlay" id="successModal">
            <div class="modal-card">
                <div class="modal-head">
                    <span>✅ Payment Submitted</span>
                </div>
                <div class="modal-body">
                    <div class="modal-row">
                        <span class="label">Date & Time:</span>
                        <span id="successDateTime">—</span>
                    </div>
                    <div class="modal-success" id="successMessageText">
                        Data submitted successfully! Receipt is being generated.
                    </div>
                    <!-- Optional: show these details for the WhatsApp message preview -->
                    <div class="modal-row">
                        <span class="label">Student:</span>
                        <span id="smStudent">—</span>
                    </div>
                    <div class="modal-row">
                        <span class="label">Course:</span>
                        <span id="smCourse">—</span>
                    </div>
                    <div class="modal-row">
                        <span class="label">Amount:</span>
                        <span id="smAmount">—</span>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-wa" id="btnShareWA">Share Receipt via WhatsApp</button>
                    <button type="button" class="btn-done" id="btnDone">Done</button>
                </div>
            </div>
        </div>
    </div>

    <script defer>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('transactionForm');
            const clearButton = document.getElementById('clearButton');
            const messageBox = document.getElementById('messageBox');
            const paymentsCheckbox = document.getElementById('payments');
            const refundsCheckbox = document.getElementById('refunds');
            const pillPayments = document.getElementById('pillPayments');
            const pillRefunds = document.getElementById('pillRefunds');

            // Success modal elements
            const successModal = document.getElementById('successModal');
            const successDateTime = document.getElementById('successDateTime');
            const smStudent = document.getElementById('smStudent');
            const smCourse = document.getElementById('smCourse');
            const smAmount = document.getElementById('smAmount');
            const btnShareWA = document.getElementById('btnShareWA');
            const btnDone = document.getElementById('btnDone');

            // Runtime cache for WA message
            let lastSubmission = {
                studentId: '',
                studentName: '',
                courseName: '',
                amount: '',
                receiptLink: '' // stays empty unless you enable CORS and return it from backend
            };

            // IMPORTANT: This has been updated with your deployed Google Apps Script Web App URL
            const GOOGLE_APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzjQ9vYDF9n-qbbjVn0FcBY7UjY-Rs0mHXRfqRGNaTBPzCSoevnnr77Cba_yLim8rCr/exec';

            // Live validation constants and cache
            const STUDENTS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3SM8IaQNp4VBBXaXmu8QuLRsJP8-wOTXKP5UM3S_BCOgp4_6IA27laZZ43-5KzUr9Q_18szJcqLOU/pub?gid=1820019961&single=true&output=csv';

            // CSV URLs for WhatsApp sharing
            const META_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3SM8IaQNp4VBBXaXmu8QuLRsJP8-wOTXKP5UM3S_BCOgp4_6IA27laZZ43-5KzUr9Q_18szJcqLOU/pub?gid=1820019961&single=true&output=csv';
            const PAYMENTS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3SM8IaQNp4VBBXaXmu8QuLRsJP8-wOTXKP5UM3S_BCOgp4_6IA27laZZ43-5KzUr9Q_18szJcqLOU/pub?gid=384282536&single=true&output=csv';

            // In-memory cache
            let studentRows = []; // array of row objects
            let lastLookupId = ''; // last looked up ID to avoid duplicate work

            // CSV fetch + parse helper (simple, robust)
            async function fetchStudents() {
                if (studentRows.length) return studentRows;
                const res = await fetch(STUDENTS_CSV_URL, { cache: 'no-store' });
                const text = await res.text();

                // Parse CSV (handles simple CSV with commas; if your data has quoted commas, we can switch to a safer parser)
                const lines = text.split(/\r?\n/).filter(Boolean);
                const header = lines.shift(); // first row header (ignored since you gave fixed columns)
                
                // Columns you specified:
                // B: Student ID, C: Student Name, H: Batch No., J: Course Name
                // We'll map by index. We must know their positions in the CSV.
                // If your CSV includes all columns A.. etc, map by index accordingly:
                // Let's defensively split and index.

                // We don't know exact column count/order beyond your mapping, so we'll derive indices once from header row if it exists.
                // If the published CSV includes headers, use them; otherwise, fall back to fixed positions.
                const headerCells = header ? splitCSVLine(header) : [];
                // Try to find headers (case-insensitive)
                const idx = {
                    studentId: headerCells.findIndex(h => /student\sid/i.test(h)),
                    studentName: headerCells.findIndex(h => /student\sname/i.test(h)),
                    batchNo: headerCells.findIndex(h => /batch/i.test(h)),
                    courseName: headerCells.findIndex(h => /course\s*name/i.test(h)),
                };

                // Fallback positions if header not found:
                // Assuming columns A.. etc: B=1, C=2, H=7, J=9, L=11, M=12 (0-based indexing)
                const fallback = { studentId: 1, studentName: 2, batchNo: 7, courseName: 9, fees: 11, paid: 12 };

                const idCol = idx.studentId >= 0 ? idx.studentId : fallback.studentId;
                const nameCol = idx.studentName >= 0 ? idx.studentName : fallback.studentName;
                const batchCol = idx.batchNo >= 0 ? idx.batchNo : fallback.batchNo;
                const courseCol = idx.courseName >= 0 ? idx.courseName : fallback.courseName;
                const feesCol = idx.fees >= 0 ? idx.fees : fallback.fees;
                const paidCol = idx.paid >= 0 ? idx.paid : fallback.paid;

                studentRows = lines.map(line => {
                    const cells = splitCSVLine(line);
                    return {
                        studentId: (cells[idCol] || '').trim(),
                        studentName: (cells[nameCol] || '').trim(),
                        batchNo: (cells[batchCol] || '').trim(),
                        courseName: (cells[courseCol] || '').trim(),
                        fees: (cells[feesCol] || '').trim(),
                        paid: (cells[paidCol] || '').trim(),
                    };
                }).filter(r => r.studentId); // keep only rows with ID
                return studentRows;
            }

            // CSV fetch helpers for WhatsApp sharing
            async function fetchCSV(url) {
                for (let i = 0; i < 2; i++) {
                    try {
                        const res = await fetch(url, { cache: 'no-store' });
                        if (!res.ok) throw new Error('HTTP ' + res.status);
                        return await res.text();
                    } catch (e) {
                        if (i === 1) throw e;
                        await new Promise(r => setTimeout(r, 400));
                    }
                }
            }

            function parseCSVWithHeader(text) {
                const lines = text.split(/\r?\n/).filter(Boolean);
                if (!lines.length) return { header: [], rows: [] };
                const header = splitCSVLine(lines.shift());
                const rows = lines.map(line => splitCSVLine(line));
                return { header, rows };
            }

            // Helper function to split CSV lines (moved outside fetchStudents for reuse)
            function splitCSVLine(line) {
                // Light parser: split by comma, handle basic quoted fields
                const out = [];
                let cur = '';
                let inQ = false;
                for (let i = 0; i < line.length; i++) {
                    const ch = line[i];
                    if (ch === '"') {
                        if (inQ && line[i+1] === '"') { cur += '"'; i++; }
                        else inQ = !inQ;
                    } else if (ch === ',' && !inQ) {
                        out.push(cur); cur = '';
                    } else {
                        cur += ch;
                    }
                }
                out.push(cur);
                return out.map(s => s.trim());
            }








            // Helpers
            function showMessage(message, type = 'success') {
                messageBox.textContent = message;
                messageBox.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
                if (type === 'success') {
                    messageBox.classList.add('bg-green-100', 'text-green-800');
                } else {
                    messageBox.classList.add('bg-red-100', 'text-red-800');
                }
                setTimeout(() => messageBox.classList.add('hidden'), 5000);
            }

            function setError(id, hasError) {
                const wrap = document.getElementById(id);
                if (!wrap) return;
                wrap.classList.toggle('has-error', !!hasError);
            }

            // UI helpers for error/clear on lookup
            function setFieldValue(id, value) {
                const el = document.getElementById(id);
                if (!el) return;
                el.value = value || '';
            }

            function clearSelectIfAny(containerId) {
                const wrap = document.getElementById(containerId);
                if (!wrap) return;
                const existing = wrap.querySelector('select.inline-select');
                if (existing) existing.remove();
            }

            function mountInlineSelect(containerId, options, onChange) {
                const wrap = document.getElementById(containerId);
                if (!wrap) return;

                clearSelectIfAny(containerId);

                const sel = document.createElement('select');
                sel.className = 'inline-select';
                sel.innerHTML = ['<option value="">Select</option>']
                    .concat(options.map(o => `<option value="${o}">${o}</option>`))
                    .join('');
                sel.addEventListener('change', () => {
                    onChange(sel.value);
                });
                wrap.appendChild(sel);
                return sel;
            }

            // Fee summary helpers
            const feeSummaryEl = document.getElementById('feeSummary');
            const feeTotalEl = document.getElementById('feeTotal');
            const feePaidEl = document.getElementById('feePaid');
            const feeDueEl = document.getElementById('feeDue');

            function parseMoney(v) {
                if (typeof v !== 'string') v = String(v ?? '');
                v = v.replace(/[,₹\s]/g, '');
                const n = parseFloat(v);
                return isNaN(n) ? 0 : n;
            }

            function formatMoney(n) {
                try {
                    return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 2 }).format(n);
                } catch {
                    return '₹' + (n.toFixed(2));
                }
            }

            function hideFeeSummary() {
                if (feeSummaryEl) feeSummaryEl.style.display = 'none';
            }

            function showFeeSummary() {
                if (feeSummaryEl) feeSummaryEl.style.display = '';
            }

            // Success modal helpers
            function openSuccessModal(msg, submission) {
                const now = new Date();
                const dt = now.toLocaleString('en-IN', { hour12: true });
                successDateTime.textContent = dt;

                document.getElementById('successMessageText').textContent = msg || 'Success';

                // Fill preview fields
                smStudent.textContent = submission.studentId && submission.studentName
                    ? `${submission.studentId} — ${submission.studentName}`
                    : (submission.studentId || submission.studentName || '—');
                smCourse.textContent = submission.courseName || '—';
                smAmount.textContent = submission.amount ? `₹${submission.amount}` : '—';

                successModal.classList.add('show');
            }

            function closeSuccessModal() {
                successModal.classList.remove('show');
            }

            function updateFeeSummaryForMatches(matches, selectedCourse) {
                if (!matches || matches.length === 0) {
                    hideFeeSummary();
                    return;
                }
                // Filter to selected course if provided
                let rows = matches;
                if (selectedCourse) {
                    rows = matches.filter(r => (r.courseName || '').toLowerCase() === selectedCourse.toLowerCase());
                }

                // Aggregate fees/paid across rows of the selected course
                let totalFees = 0;
                let totalPaid = 0;
                rows.forEach(r => {
                    totalFees += parseMoney(r.fees);
                    totalPaid += parseMoney(r.paid);
                });
                const due = Math.max(totalFees - totalPaid, 0);

                feeTotalEl.textContent = formatMoney(totalFees);
                feePaidEl.textContent = formatMoney(totalPaid);
                feeDueEl.textContent = formatMoney(due);
                showFeeSummary();
            }

            function toggleTypePills() {
                // Remove active class from both pills first
                pillPayments.classList.remove('active');
                pillRefunds.classList.remove('active');
                
                // Add active class to the checked one
                if (paymentsCheckbox.checked) {
                    pillPayments.classList.add('active');
                } else if (refundsCheckbox.checked) {
                    pillRefunds.classList.add('active');
                }
                
                // Debug logging
                console.log('Pills updated:', {
                    payments: paymentsCheckbox.checked,
                    refunds: refundsCheckbox.checked,
                    pillPaymentsActive: pillPayments.classList.contains('active'),
                    pillRefundsActive: pillRefunds.classList.contains('active')
                });
            }

            // Radio change handlers (mutual exclusivity handled by radio itself)
            paymentsCheckbox.addEventListener('change', toggleTypePills);
            refundsCheckbox.addEventListener('change', toggleTypePills);

            // Clicking the pill toggles the radio (helps older iOS)
            pillPayments.addEventListener('click', (e) => {
                if (e.target.tagName !== 'INPUT') paymentsCheckbox.checked = true;
                toggleTypePills();
                paymentsCheckbox.dispatchEvent(new Event('change'));
            });
            pillRefunds.addEventListener('click', (e) => {
                if (e.target.tagName !== 'INPUT') refundsCheckbox.checked = true;
                toggleTypePills();
                refundsCheckbox.dispatchEvent(new Event('change'));
            });

            // Prevent Enter key on text inputs from accidental submit
            form.querySelectorAll('input[type="text"]').forEach(inp => {
                inp.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') e.preventDefault();
                });
            });

            // Initialize pill states
            toggleTypePills();

            // Success modal event listeners
            btnShareWA.addEventListener('click', async () => {
                try {
                    // Ensure required fields exist
                    const sid = (lastSubmission.studentId || '').trim();
                    const course = (lastSubmission.courseName || '').trim();
                    if (!sid) {
                        showMessage('Student ID missing for WhatsApp share.', 'error');
                        return;
                    }

                    // Fetch meta CSV (with retry)
                    const metaText = await fetchCSV(META_CSV_URL);
                    const meta = parseCSVWithHeader(metaText);

                    // Find columns (fallback indexes if headers not found)
                    const mh = meta.header.map(h => h.trim());
                    const idx = {
                        studentId: mh.findIndex(h => /student\s*id/i.test(h)),
                        courseName: mh.findIndex(h => /course\s*name/i.test(h)),
                        phone: mh.findIndex(h => /phone|mobile|contact/i.test(h)),   // E
                        fees: mh.findIndex(h => /fees|fee\s*amount/i.test(h)),       // L
                        paid: mh.findIndex(h => /paid/i.test(h)),                    // M
                    };
                    const fb = { studentId: 1, courseName: 9, phone: 4, fees: 11, paid: 12 };

                    const idCol = idx.studentId >= 0 ? idx.studentId : fb.studentId;
                    const courseCol = idx.courseName >= 0 ? idx.courseName : fb.courseName;
                    const phoneCol = idx.phone >= 0 ? idx.phone : fb.phone;
                    const feesCol = idx.fees >= 0 ? idx.fees : fb.fees;
                    const paidCol = idx.paid >= 0 ? idx.paid : fb.paid;

                    const match = meta.rows.find(r =>
                        (r[idCol] || '').toLowerCase() === sid.toLowerCase() &&
                        (!course || (r[courseCol] || '').toLowerCase() === course.toLowerCase())
                    );
                    if (!match) {
                        showMessage('Could not find student details for WhatsApp share.', 'error');
                        return;
                    }

                    // Phone normalize
                    let phone = String(match[phoneCol] || '').replace(/\D/g, '');
                    if (phone.startsWith('0')) phone = phone.slice(1);
                    if (!phone.startsWith('91')) phone = '91' + phone;
                    if (phone.length < 12) {
                        showMessage('Invalid phone number for WhatsApp share.', 'error');
                        return;
                    }

                    // Fees/Paid/Due
                    const fees = String(match[feesCol] || '');
                    const paid = String(match[paidCol] || '');
                    const toNum = v => {
                        if (typeof v !== 'string') v = String(v ?? '');
                        v = v.replace(/[,₹\s]/g, '');
                        const n = parseFloat(v);
                        return isNaN(n) ? 0 : n;
                    };
                    const due = Math.max(toNum(fees) - toNum(paid), 0);

                    // Payments CSV for receipt link
                    const payText = await fetchCSV(PAYMENTS_CSV_URL);
                    const pay = parseCSVWithHeader(payText);
                    const ph = pay.header.map(h => h.trim());
                    const pidx = {
                        type: ph.findIndex(h => /^type$/i.test(h)),
                        studentId: ph.findIndex(h => /^student\s*id$/i.test(h)),
                        courseName: ph.findIndex(h => /^course\s*name$/i.test(h)),
                        receiptLink: ph.findIndex(h => /^receipt\s*link$/i.test(h)), // M
                    };
                    const pfb = { type: 1, studentId: 2, courseName: 8, receiptLink: 12 };
                    const typeCol = pidx.type >= 0 ? pidx.type : pfb.type;
                    const sidCol = pidx.studentId >= 0 ? pidx.studentId : pfb.studentId;
                    const pcourseCol = pidx.courseName >= 0 ? pidx.courseName : pfb.courseName;
                    const linkCol = pidx.receiptLink >= 0 ? pidx.receiptLink : pfb.receiptLink;

                    const filtered = pay.rows.filter(r =>
                        (r[typeCol] || '').toLowerCase() === 'payments' &&
                        (r[sidCol] || '').toLowerCase() === sid.toLowerCase() &&
                        (!course || (r[pcourseCol] || '').toLowerCase() === course.toLowerCase())
                    );
                    const receiptLink = filtered.length ? (filtered[filtered.length - 1][linkCol] || '') : '';

                    // Compose message and redirect to wa.me
                    const msg = [
                        "Great news! Your payment receipt is ready—check out the attached link!",
                        receiptLink ? receiptLink : '',
                        `Current status: Balance Due — '${due}'.`,
                        "Don't worry, you're just a click away from wrapping this up."
                    ].filter(Boolean).join('\n\n');

                    const waUrl = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;

                    // Top-level navigation (avoid iframe)
                    window.location.href = waUrl;
                } catch (e) {
                    console.error('WA share error', e);
                    showMessage('Unable to prepare WhatsApp message. Please try again.', 'error');
                }
            });

            btnDone.addEventListener('click', () => closeSuccessModal());

            // Also close on overlay click (optional)
            successModal.addEventListener('click', (e) => {
                if (e.target === successModal) closeSuccessModal();
            });

            // Main: lookup on Student ID change/blur
            const studentIdEl = document.getElementById('studentId');
            const studentNameEl = document.getElementById('studentName');
            const courseNameEl = document.getElementById('courseName');
            const batchNoEl = document.getElementById('batchNo');

            async function lookupByStudentId() {
                const id = (studentIdEl.value || '').trim();
                if (!id || id === lastLookupId) return;
                lastLookupId = id;

                // Clear dependent fields and dropdowns first
                setFieldValue('studentName', '');
                setFieldValue('courseName', '');
                setFieldValue('batchNo', '');
                clearSelectIfAny('field-courseName');
                clearSelectIfAny('field-batchNo');

                try {
                    const rows = await fetchStudents();
                    const matches = rows.filter(r => r.studentId.toLowerCase() === id.toLowerCase());

                    // Validate ID
                    if (matches.length === 0) {
                        showMessage('Invalid Student ID. Please check and try again.', 'error');
                        setFieldValue('studentName', '');
                        setFieldValue('courseName', '');
                        setFieldValue('batchNo', '');
                        hideFeeSummary();
                        // Mark field as error for UX
                        document.getElementById('field-studentId').classList.add('has-error');
                        return;
                    } else {
                        document.getElementById('field-studentId').classList.remove('has-error');
                    }

                    // Student Name: use first unique value
                    const nameSet = Array.from(new Set(matches.map(m => m.studentName).filter(Boolean)));
                    setFieldValue('studentName', nameSet[0] || '');

                    // Course(s)
                    const courses = Array.from(new Set(matches.map(m => m.courseName).filter(Boolean)));
                    if (courses.length <= 1) {
                        const only = courses[0] || '';
                        setFieldValue('courseName', only);
                        updateFeeSummaryForMatches(matches, only);
                    } else {
                        // Let user choose
                        const sel = mountInlineSelect('field-courseName', courses, (val) => {
                            setFieldValue('courseName', val);
                            updateFeeSummaryForMatches(matches, val);
                        });
                        // If there is a most frequent course, preselect it; otherwise keep summary hidden until user picks
                        hideFeeSummary();
                    }

                    // Batch(es) — if multiple for same ID, offer select
                    const batches = Array.from(new Set(matches.map(m => m.batchNo).filter(Boolean)));
                    if (batches.length <= 1) {
                        setFieldValue('batchNo', batches[0] || '');
                    } else {
                        // Let user choose
                        mountInlineSelect('field-batchNo', batches, (val) => {
                            setFieldValue('batchNo', val);
                        });
                    }
                } catch (err) {
                    console.error('Lookup error:', err);
                    showMessage('Could not fetch student data. Please try again.', 'error');
                }
            }

            // Trigger lookup on blur and when pressing Enter
            studentIdEl.addEventListener('blur', lookupByStudentId);
            studentIdEl.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    lookupByStudentId();
                }
            });

            // If user edits Student ID after a selection, allow re-lookup
            studentIdEl.addEventListener('input', () => {
                // Reset lastLookupId so blur triggers again with new value
                lastLookupId = '';
                // Clear dependent values if ID is being changed
                setFieldValue('studentName', '');
                setFieldValue('courseName', '');
                setFieldValue('batchNo', '');
                clearSelectIfAny('field-courseName');
                clearSelectIfAny('field-batchNo');
                hideFeeSummary();
            });

            // Update fee summary when course name is manually edited
            courseNameEl.addEventListener('blur', async () => {
                const id = (studentIdEl.value || '').trim();
                if (!id) return;
                try {
                    const rows = await fetchStudents();
                    const matches = rows.filter(r => (r.studentId || '').toLowerCase() === id.toLowerCase());
                    if (matches.length) {
                        const selectedCourse = (courseNameEl.value || '').trim();
                        updateFeeSummaryForMatches(matches, selectedCourse);
                    }
                } catch {}
            });

            // Amount: allow numbers and dot; format lightly
            const amountEl = document.getElementById('amount');
            let amountTouched = false;
            
            amountEl.addEventListener('input', () => {
                let v = amountEl.value.replace(/[^\d.]/g, '');
                const parts = v.split('.');
                if (parts.length > 2) v = parts[0] + '.' + parts.slice(1).join('');
                amountEl.value = v;
            });

            // Auto-fill Amount with Due when user focuses Amount the first time
            amountEl.addEventListener('focus', () => {
                if (amountTouched) return;
                const dueText = feeDueEl?.textContent || '';
                const due = parseMoney(dueText);
                if (due > 0 && !amountEl.value) {
                    amountEl.value = due.toString();
                }
                amountTouched = true;
            });

            // Inline validation on submit
            function validateForm() {
                let ok = true;

                // Type required
                const typeSelected = paymentsCheckbox.checked || refundsCheckbox.checked;
                document.getElementById('typeHelper').style.display = typeSelected ? 'none' : 'block';
                ok = ok && typeSelected;

                const required = [
                    'field-studentId',
                    'field-studentName',
                    'field-courseName',
                    'field-batchNo',
                    'field-amount',
                    'field-modeOfPayment',
                    'field-paymentType',
                    'field-txId',
                    'field-dateOfPayment',
                    'field-note'
                ];

                required.forEach(id => {
                    const wrap = document.getElementById(id);
                    if (!wrap) return;
                    const input = wrap.querySelector('input, select, textarea');
                    const value = (input?.value || '').trim();
                    const hasError = !value;
                    setError(id, hasError);
                    ok = ok && !hasError;
                });

                // Amount numeric check
                const amountVal = (amountEl.value || '').trim();
                if (!/^\d+(\.\d{1,2})?$/.test(amountVal)) {
                    setError('field-amount', true);
                    ok = false;
                }

                // Final validation: require valid ID-derived fields
                const idOk = (studentNameEl.value || '').trim().length > 0;
                if (!idOk) {
                    // If ID didn't resolve to a name, mark as error
                    document.getElementById('field-studentId').classList.add('has-error');
                }
                ok = ok && idOk;

                return ok;
            }

            // Submit
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!validateForm()) {
                    showMessage('Please fix the highlighted fields.', 'error');
                    return;
                }

                // Collect form data
                const formData = new FormData(form);
                const data = {};
                for (let [key, value] of formData.entries()) {
                    if (key === 'type') {
                        // skip; we set below from the pills
                    } else {
                        data[key] = value;
                    }
                }

                data.type = paymentsCheckbox.checked ? paymentsCheckbox.value : refundsCheckbox.checked ? refundsCheckbox.value : '';

                // Button state
                const saveBtn = document.getElementById('saveButton');
                const originalSaveText = saveBtn.textContent;
                saveBtn.textContent = 'Saving...';
                saveBtn.disabled = true;

                try {
                    await fetch(GOOGLE_APPS_SCRIPT_WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data),
                    });

                    // Assume success (no-cors)
                    lastSubmission = {
                        studentId: data.studentId,
                        studentName: data.studentName,
                        courseName: data.courseName,
                        amount: data.amount,
                        receiptLink: '' // fill later if backend returns it
                    };

                    // Open modal
                    openSuccessModal('Data submitted successfully! Receipt will be available shortly.', lastSubmission);

                    // Clear form after showing modal
                    form.reset();
                    paymentsCheckbox.checked = false;
                    refundsCheckbox.checked = false;
                    toggleTypePills();
                } catch (error) {
                    console.error('Error submitting data:', error);
                    showMessage('Error submitting data. Please try again.', 'error');
                } finally {
                    saveBtn.textContent = originalSaveText;
                    saveBtn.disabled = false;
                    // Clear error states after successful reset
                    document.querySelectorAll('.has-error').forEach(n => n.classList.remove('has-error'));
                    document.getElementById('typeHelper').style.display = 'none';
                    hideFeeSummary();
                    clearSelectIfAny('field-courseName');
                    clearSelectIfAny('field-batchNo');
                    amountTouched = false;
                }
            });

            // Clear
            clearButton.addEventListener('click', () => {
                form.reset();
                paymentsCheckbox.checked = false;
                refundsCheckbox.checked = false;
                toggleTypePills();
                document.querySelectorAll('.has-error').forEach(n => n.classList.remove('has-error'));
                document.getElementById('typeHelper').style.display = 'none';
                showMessage('Form cleared.', 'success');
            });
        });
    </script>
</body>
</html>
